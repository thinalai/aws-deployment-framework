
# // Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
# // SPDX-License-Identifier: Apache-2.0

AWSTemplateFormatVersion: "2010-09-09"
Description: ADF CloudFormation Template (Global) for IAM in the Target Accounts

Parameters:
  DeploymentAccountId:
    Type: "AWS::SSM::Parameter::Value<String>"
    Description: Deployment Account ID
    Default: deployment_account_id
  # OrgStage can be set in the respective adfconfig file using the 
  # path config.org.stage
  OrgStage:
    Type: "AWS::SSM::Parameter::Value<String>"
    Description: A stage used to differentiate Multi-Org ADF environments
    Default: /adf/org/stage

# Org StageCustom Mappings allows you to dynamically build different IAM 
# Conditions / Principals ARN / Resource ARN per Organization applying
# least-privilege principles whilst retaining a Single Stack Definition for all
# environments.
# usage !FindInMap[OrgStageMap: !Ref OrgStage, ExampleCustomProperty]
Mappings:
  OrgStageMap:
    Dev:
      ExampleCustomProperty: 1234
    Int:
      ExampleCustomProperty: 5678
    Prod:
      ExampleCustomProperty: 9102

Resources:
  CloudFormationDeploymentPolicy:
    # This is the policy that will be used to deploy CloudFormation resources from
    # within the target account. You should scope this policy depending
    # On what you would like to deploy within certain Organizational Units.
    # NOTE: below is a sample IAM policy. This policies should NOT be used for
    # purposes other than testing.
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: "custom-adf-cloudformation-deployment-role-policy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Sid: "CloudFormation"
            Action:
              # These below actions are examples, change these to your requirements..
              - "apigateway:*"
              - "cloudformation:*"  # You will need CloudFormation actions in order to work with CloudFormation
              - "ecr:*"
              - "ecs:*"
              - "ec2:*"
              - "iam:*"
              - "logs:*"
              - "s3:*"
              - "codedeploy:*"
              - "autoscaling:*"
              - "cloudwatch:*"
              - "elasticloadbalancing:*"
              - "ssm:*"
              - "kms:CreateAlias"
              - "kms:CreateKey"
              - "kms:DeleteAlias"
              - "kms:UpdateAlias"
              - "kms:Decrypt"
              - "kms:Describe*"
              - "kms:Enable*"
              - "kms:Encrypt"
              - "kms:GenerateDataKey*"
              - "kms:List*"
              - "kms:Put*"
              - "kms:ReEncrypt*"
              - "kms:ScheduleKeyDeletion"
              - "kms:Update*"
              - "kms:TagResource"
              - "kms:ListResourceTags"
            Resource:
              - "*"
      Roles:
        # This role is created in the global.yml and is the default
        # CloudFormation deployment role for ADF.
        - adf-cloudformation-deployment-role

Outputs:
  DeploymentAccountId:
    Value: !Ref DeploymentAccountId